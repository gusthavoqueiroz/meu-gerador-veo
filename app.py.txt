import streamlit as st
import openai
import anthropic
import os

st.set_page_config(page_title="Audio -> Veo 3 Prompts", layout="wide")

st.title("ðŸŽ¬ Gerador de Prompts para Veo 3 (8s)")
st.markdown("Converta Ã¡udio em roteiros visuais segmentados.")

with st.sidebar:
    st.header("ðŸ”‘ API Keys")
    oa_key = st.text_input("OpenAI Key (para o Ã¡udio)", type="password")
    cl_key = st.text_input("Claude Key (para os prompts)", type="password")
    estilo = st.text_input("Estilo Visual", value="Cinematic, 8k, realistic, high detail")

audio_file = st.file_uploader("Suba o Ã¡udio aqui", type=['mp3', 'wav', 'm4a'])

if st.button("Gerar Prompts") and audio_file and oa_key and cl_key:
    try:
        # 1. TranscriÃ§Ã£o com OpenAI
        client_oa = openai.OpenAI(api_key=oa_key)
        with open("temp_audio.mp3", "wb") as f:
            f.write(audio_file.getbuffer())
        
        st.info("âŒ› Transcrevendo Ã¡udio...")
        transcript = client_oa.audio.transcriptions.create(
            model="whisper-1", 
            file=open("temp_audio.mp3", "rb"),
            response_format="verbose_json",
            timestamp_granularities=["segment"]
        )

        # 2. Processamento com Claude
        st.info("âŒ› Claude criando prompts de 8 segundos...")
        client_cl = anthropic.Anthropic(api_key=cl_key)
        
        texto_com_tempo = ""
        for s in transcript.segments:
            texto_com_tempo += f"[{s['start']}-{s['end']}s]: {s['text']}\n"

        prompt_final = f"""Com base nesta transcriÃ§Ã£o:
        {texto_com_tempo}
        
        Crie uma tabela de prompts para o gerador de vÃ­deo VEO 3.
        REGRAS:
        1. Divida em blocos de EXATAMENTE 8 segundos (0-8s, 8-16s, etc).
        2. Estilo visual: {estilo}.
        3. Prompts em INGLÃŠS.
        4. Foque em movimento de cÃ¢mera e iluminaÃ§Ã£o.
        Formate como Tabela: Tempo | Texto Original | Prompt Veo 3"""

        message = client_cl.messages.create(
            model="claude-3-5-sonnet-20240620",
            max_tokens=4000,
            messages=[{"role": "user", "content": prompt_final}]
        )

        st.success("âœ… Pronto!")
        st.markdown(message.content[0].text)
        os.remove("temp_audio.mp3")

    except Exception as e:
        st.error(f"Erro: {e}")